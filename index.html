<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualisasi Data Tsunami Interaktif</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Moment.js for robust date/time handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.js"></script>

    <!-- Configure Tailwind for Inter font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Style for the 4:5 aspect ratio map container, perfect for social media post */
        #map-frame {
            position: relative;
            width: 100%;
            /* TINGGI DIKURANGI 10% DARI 85% MENJADI 75% */
            padding-bottom: 75%; 
            overflow: hidden; 
            /* Sudut bawah dibiarkan lurus agar menempel sempurna pada blok detail */
            border-bottom-left-radius: 0; 
            border-bottom-right-radius: 0;
        }
        #map-container-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Custom map info box to mimic the image */
        .map-info-box {
            background-color: rgba(255, 255, 255, 0.85);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); /* Added stronger shadow for aesthetic */
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Styling for the main detail grid based on the provided image */
        #detail-grid {
            /* RASIO BARU DARI 1fr 2fr MENJADI 1fr 2.5fr */
            display: grid;
            grid-template-columns: 1fr 2.5fr; 
            min-height: 200px;
            /* Pastikan menempel pada peta */
            margin-top: -5px; 
            position: relative;
            z-index: 20; 
        }
        
        /* Specific styling for the left (colored) block - MAG/TIME/KEDALAMAN */
        .mag-time-block {
            padding: 1.5rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: white;
            position: relative;
            z-index: 10;
            /* Sudut kanan atas disesuaikan agar menempel dengan status banner */
            border-top-right-radius: 0; 
        }
        
        /* UKURAN FONT MAGNITUDO RESPONSIVE (6VW) */
        #display-magnitude {
            /* Font size akan dihitung berdasarkan 6% dari lebar viewport (vw) */
            font-size: 6vw; 
            /* Set ukuran font maksimum lebih kecil */
            max-font-size: 50px; 
            font-weight: 900;
            line-height: 1;
        }
        
        /* FONT SIZE UNTUK WAKTU DIKECILKAN */
        .time-container {
            font-size: 0.8rem; /* Ukuran font lebih kecil untuk tanggal/waktu */
        }
        .time-container svg {
             width: 1rem; /* Ikon juga sedikit dikecilkan */
             height: 1rem;
        }


        /* Specific styling for the right (white) block - LOKASI/GUNCANGAN/AREA */
        .status-area-block {
            padding: 0; /* Padding dihilangkan dari container utama */
            display: flex;
            flex-direction: column;
            background-color: white;
            color: #1f2937; /* Gray-800 */
        }

        /* Status Banner menempel di bagian atas blok kanan */
        #display-tsunami {
            width: 100%;
            /* PADDING DIHILANGKAN DARI STYLE INLINE DAN DIGANTI TAILWIND UTILITY DI BAWAH */
            box-sizing: border-box;
            border-top-left-radius: 0;
            line-height: 1.2; 
        }

        /* Konten detail di bawah status banner */
        #detail-content-wrapper {
            padding: 1.5rem;
            /* Padding atas dihilangkan untuk menempelkan judul ke status banner */
            padding-top: 0; 
            /* HAPUS PADDING BAWAH PADA DETAIL WRAPPER AGAR MELEKAT */
            padding-bottom: 0; 
        }
        
        /* Custom Seismic Icon Styling (HAPUS ANIMASI PULSE) */
        .seismic-icon {
            /* Pastikan tidak ada animasi */
        }
        
        /* Styling untuk Tabel BMKG dan Recorded (dioptimalkan agar ringkas) */
        .compact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; 
            margin-top: 0; /* Hapus margin top */
        }
        /* Optimasi spasi judul tabel */
        .list-header {
            /* MENGOPTIMALKAN SPASI ATAS BAWAH JUDUL TABEL */
            margin-top: 0;
            margin-bottom: 0.1rem; 
        }
        .compact-table th, .compact-table td {
            /* PADDING VERTIKAL DIKURANGI EKSTREM */
            padding-left: 0.15rem;
            padding-right: 0.15rem;
            /* PADDING VERTICAL SUPER-COMPACT */
            padding-top: 0.02rem; 
            padding-bottom: 0.02rem;
            text-align: left;
            /* HAPUS GARIS HORIZONTAL DAN VERTIKAL */
            border-bottom: none; 
        }
        .compact-table th {
            font-weight: 600;
            background-color: #f3f4f6;
            font-size: 0.7rem; 
            /* HAPUS GARIS BAWAH HEADERS */
            border-bottom: none; 
        }
        .compact-table td {
            /* HAPUS GARIS BAWAH KONTEN */
            border-bottom: none; 
            /* LINE HEIGHT DIKURANGI */
            line-height: 1.1; 
        }
        /* Optimasi spasi caption total wilayah */
        #total-bmkg-caption, #total-recorded-caption {
            /* HAPUS MARGIN ATAS DAN BAWAH */
            margin-top: 0.1rem; 
            margin-bottom: 0;
            font-size: 0.7rem; /* Kecilkan font caption total */
        }
        
        /* === BMKG STATUS BADGES === */
        .bmkg-status-cell {
            font-weight: 600; 
            text-align: center; 
            border-radius: 0.25rem;
            padding: 0.1rem 0.4rem; 
            min-width: 80px; /* Lebar seragam */
            display: inline-block; 
        }
        .status-awas { background-color: #DC2626; color: #ffffff; }
        .status-siaga { background-color: #f59e0b; color: #ffffff; }
        .status-waspada { background-color: #fde047; color: #1f2937; }
        .bmkg-center-content { text-align: center; }

        /* === RECORDED HEIGHT BADGES (NEW) === */
        .recorded-height-cell {
            font-weight: 700;
            text-align: center;
            border-radius: 0.25rem;
            padding: 0.1rem 0.4rem; 
            min-width: 65px; 
            display: inline-block;
            color: #1f2937;
        }
        /* MAPPING WARNA KETINGGIAN */
        .h-005-03 { background-color: #00BFFF; color: #fff; } /* Biru Muda */
        .h-03-1 { background-color: #FFFF00; color: #1f2937; } /* Kuning (Text Hitam) */
        .h-1-3 { background-color: #FFA500; color: #fff; } /* Orange */
        .h-3-10 { background-color: #FF0000; color: #fff; } /* Merah */
        .h-10-plus { background-color: #800080; color: #fff; } /* Ungu */
        
        /* LEGEND STYLING */
        .info-legend {
            background: white;
            padding: 6px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            font-size: 0.7rem;
            color: #333;
            max-width: 150px;
        }
        /* Style baru untuk kotak berwarna di legenda */
        .legend-square { 
            width: 12px; /* Lebar kotak */
            height: 12px; /* Tinggi kotak */
            float: left;
            margin-right: 5px;
            /* Menghilangkan radius 50% untuk membuat kotak */
            border-radius: 3px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .info-legend span {
            display: block;
            margin-bottom: 2px;
        }

        /* Marker Peringatan Global yang diperbaiki */
        .global-warning-marker {
            /* Menghapus background-color Leaflet yang mengganggu */
            background: none !important; 
            border: none !important;
            box-shadow: none !important;
            /* Menghilangkan elemen visual Leaflet yang mengganggu rendering SVG */
            line-height: 0;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-6 font-semibold text-center">Tsunami Data Visualizer</h1>
        <p class="lg:text-gray-600 mb-8 text-center">Masukkan data gempa sumber dan wilayah yang berpotensi terdampak untuk visualisasi peta.</p>

        <!-- Page 1: Input Form -->
        <div id="input-page" class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl border-t-4 border-blue-600">
            <form id="tsunami-form" class="space-y-8">
                
                <!-- Section 1: Data Gempa Sumber (CSV 1) -->
                <div class="border-b border-gray-200 pb-8">
                    <h2 class="text-2xl font-semibold leading-7 text-gray-900 mb-4">1. Data Gempa Sumber Tsunami</h2>
                    <p class="text-sm leading-6 text-gray-600">Gunakan format CSV: **mag,kedalaman,waktu,lat,long,lokasi**. Hanya satu baris data.</p>
                    <div class="mt-4">
                        <textarea id="csv1-input" name="csv1_input" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-sm" placeholder="mag,kedalaman,waktu,lat,long,lokasi
7.1,10.0,2025-09-25T16:44:55Z,45.21,148.55,&quot;Kepulauan Kuril Selatan&quot;"></textarea>
                    </div>
                </div>

                <!-- Section 2: Status Peringatan Tsunami (Global) -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 border-b border-gray-200 pb-8">
                    <div class="md:col-span-4">
                        <h2 class="text-2xl font-semibold leading-7 text-gray-900 mb-4">2. Status Peringatan Tsunami</h2>
                    </div>
                    <!-- Status Tsunami Options (Full Width) -->
                    <div id="status-options" class="col-span-4 grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <label class="p-3 border border-red-300 rounded-lg cursor-pointer hover:bg-red-50 transition-colors bg-red-100/50">
                            <input type="radio" name="tsunami_status" value="Berpotensi Tsunami" required class="form-radio h-4 w-4 text-red-600">
                            <span class="ml-3 text-base font-medium text-red-700">Berpotensi Tsunami</span>
                            <!-- KETERANGAN BARU -->
                            <p class="text-xs text-red-500 mt-1 pl-6">Memerlukan Data Gempa (1) & Wilayah Potensi Global (3) / BMKG (4).</p>
                            <!-- END KETERANGAN -->
                        </label>
                         <!-- OPSI BARU -->
                        <label class="p-3 border border-red-500 rounded-lg cursor-pointer hover:bg-red-50 transition-colors bg-red-100/50">
                            <input type="radio" name="tsunami_status" value="TSUNAMI MASIH BERLANGSUNG" class="form-radio h-4 w-4 text-red-700">
                            <span class="ml-3 text-base font-medium text-red-800">Tsunami Masih Berlangsung</span>
                            <!-- KETERANGAN BARU -->
                            <p class="text-xs text-red-600 mt-1 pl-6">Memerlukan Data Gempa (1) & Tsunami Terekam (5).</p>
                            <!-- END KETERANGAN -->
                        </label>
                        <!-- END OPSI BARU -->
                        <label class="p-3 border border-yellow-300 rounded-lg cursor-pointer hover:bg-yellow-50 transition-colors bg-yellow-100/50">
                            <input type="radio" name="tsunami_status" value="Tidak Berpotensi Tsunami" class="form-radio h-4 w-4 text-yellow-600">
                            <span class="ml-3 text-base font-medium text-yellow-700">Tidak Berpotensi Tsunami</span>
                             <!-- KETERANGAN BARU -->
                            <p class="text-xs text-yellow-600 mt-1 pl-6">Memerlukan Data Gempa (1) saja.</p>
                            <!-- END KETERANGAN -->
                        </label>
                        <label class="p-3 border border-green-300 rounded-lg cursor-pointer hover:bg-green-50 transition-colors bg-green-100/50">
                            <input type="radio" name="tsunami_status" value="Tsunami Telah Berakhir" class="form-radio h-4 w-4 text-green-600">
                            <span class="ml-3 text-base font-medium text-green-700">Tsunami Telah Berakhir</span>
                            <!-- KETERANGAN BARU -->
                            <p class="text-xs text-green-600 mt-1 pl-6">Memerlukan Data Gempa (1) & Tsunami Terekam (5) (Resume).</p>
                            <!-- END KETERANGAN -->
                        </label>
                    </div>
                </div>

                <!-- Section 3: Data Wilayah Terdampak (CSV 2 - International) -->
                <div class="border-b border-gray-200 pb-8">
                    <h2 class="text-2xl font-semibold leading-7 text-gray-900 mb-4">3. Data Wilayah Berpotensi Terdampak (Global)</h2>
                    <p class="text-sm leading-6 text-gray-600">Gunakan format CSV: **lokasi,negara,lat,long,eta**. Masukkan data wilayah terdampak (bisa lebih dari satu baris).</p>
                    <div class="mt-4">
                        <textarea id="csv2-input" name="csv2_input" rows="6" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-sm" placeholder="lokasi,negara,lat,long,eta
Kuril Islands,Russia,45.3,149.0,2025-09-25T17:15:00Z
Hokkaido,Jepang,42.5,145.0,2025-09-25T17:45:00Z
Maui,USA,20.79, -156.33, 2025-09-25T20:00:00Z
Mexico City,Mexico,19.43,-99.13,2025-09-25T22:30:00Z
Lima,Peru,-12.04,-77.04,2025-09-26T01:00:00Z
Sydney,Australia,-33.86,151.20,2025-09-26T03:00:00Z
Auckland,NZ,-36.84,174.76,2025-09-26T04:00:00Z
Manila,Philippines,14.59,120.98,2025-09-26T05:30:00Z
Vancouver,Canada,49.28,-123.12,2025-09-26T07:00:00Z"></textarea>
                    </div>
                </div>

                <!-- Section 4: Data Wilayah Terdampak (CSV 4 - BMKG) -->
                <div class="border-b border-gray-200 pb-8">
                    <h2 class="text-2xl font-semibold leading-7 text-gray-900 mb-4">4. Data Wilayah Berpotensi Terdampak (BMKG)</h2>
                    <p class="text-sm leading-6 text-gray-600">Gunakan format CSV: **provinsi,kotakab,status,eta**. Hanya untuk wilayah Indonesia.</p>
                    <div class="mt-4">
                        <textarea id="csv-bmkg-input" name="csv_bmkg_input" rows="4" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-sm" placeholder="provinsi,kotakab,status,eta
SULAWESI UTARA,KEPULAUAN SANGIHE,AWAS,2025-09-25T16:55:00Z
PAPUA,JAYAPURA,Siaga,2025-09-25T17:15:00Z
SULUT,KEPULAUAN TALAUD,Waspada,2025-09-25T17:45:00Z
MALUT,HALMAHERA UTARA,Waspada,2025-09-26T01:00:00Z
NTT,KABUPATEN ALOR,Waspada,2025-09-26T01:30:00Z
MALUKU,KOTA AMBON,Siaga,2025-09-26T02:00:00Z
BANTEN,PANDEGLANG,Waspada,2025-09-26T02:30:00Z
SUMUT,NIAS SELATAN,Siaga,2025-09-26T03:00:00Z
ACEH,PULAU SIMEULUE,Waspada,2025-09-26T03:30:00Z
PAPUABAR,MANOKWARI,Waspada,2025-09-26T04:00:00Z
SULSEL,KABUPATEN SELAYAR,Siaga,2025-09-26T04:30:00Z
MALUKU UTARA,KABUPATEN PULAU MOROTAI,AWAS,2025-09-26T05:00:00Z"></textarea>
                    </div>
                </div>

                <!-- Section 5: Data Tsunami Terekam (CSV 5 - Recorded) -->
                <div>
                    <h2 class="text-2xl font-semibold leading-7 text-gray-900 mb-4">5. Data Tsunami Terekam (Observed)</h2>
                    <p class="text-sm leading-6 text-gray-600">Gunakan format CSV: **lokasi1,lokasi2,lat,long,tinggi,waktu**.</p>
                    <div class="mt-4">
                        <textarea id="csv-recorded-input" name="csv_recorded_input" rows="4" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-3 text-sm" placeholder="lokasi1,lokasi2,lat,long,tinggi,waktu
Fukushima,Jepang,37.5,141.0,0.25,2025-09-25T18:00:00Z
Kilauea,Hawaii,19.5,-155.0,0.85,2025-09-25T21:30:00Z
Hilo,Hawaii,19.7,-155.1,1.5,2025-09-26T01:00:00Z
Valparaiso,Chile,-33.0,-71.6,4.5,2025-09-26T04:30:00Z
Lombok,Indonesia,-8.5,116.0,12.5,2025-09-26T06:00:00Z"></textarea>
                    </div>
                </div>

                <div id="error-message" class="text-red-700 font-medium hidden p-3 bg-red-100 rounded-lg border border-red-300"></div>

                <!-- Submit Button -->
                <div class="pt-5">
                    <button type="submit" class="w-full justify-center rounded-lg bg-blue-600 px-6 py-3 text-lg font-semibold text-white shadow-xl hover:bg-blue-700 transition duration-300 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
                        Visualisasikan Peta & Buat Laporan
                    </button>
                </div>
            </form>
        </div>

        <!-- Page 2: Visualization & Report -->
        <div id="visualization-page" class="hidden">
            <!-- Main Card Wrapper (Portrait, Social Media Ready) -->
            <div id="visualization-card" class="bg-white shadow-2xl overflow-hidden md:max-w-2xl mx-auto">
                
                <!-- Map Container (4:3 ratio for map), Pinned to top -->
                <div id="map-frame" class="relative">
                    <div id="map-container-wrapper">
                        <div id="map" class="w-full h-full"></div>
                    </div>
                </div>

                <!-- Detail Report Section (Revised Layout: Colored Block vs White Block) -->
                <div id="detail-grid" class="mt-0">
                    
                    <!-- LEFT BLOCK: MAGNITUDE, TIME, KEDALAMAN (Colored Dynamically) -->
                    <div id="mag-time-container" class="mag-time-block text-center"> 
                        
                        <!-- Waktu -->
                        <div id="display-time-container" class="time-container">
                        </div>
                        
                        <!-- MAGNITUDE (Center) -->
                        <div class="text-center my-2">
                            <!-- ID display-magnitude, menggunakan ukuran responsif dari CSS -->
                            <p id="display-magnitude" class="font-black leading-none mt-1">7.1</p>
                        </div>

                        <!-- Kedalaman (Bottom) -->
                        <div class="flex items-center space-x-2 text-sm justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 12.343l-3.535 3.536m-2.829-2.829l-3.535 3.536m-2.121-2.121L3 17.25m18-10.5L3 6.75m18 0l-3.535 3.536" /></svg>
                            <p id="display-kedalaman" class="font-semibold text-white">10 Km</p>
                        </div>
                        
                    </div>
                    
                    <!-- RIGHT BLOCK: STATUS & AREA LIST (White Background) -->
                    <div class="status-area-block">
                        <!-- Tsunami Status (Top Right - Colored Banner) -->
                        <p id="display-tsunami" class="font-extrabold text-xl transition-colors border-none p-4 flex items-center justify-center" style="padding-top: 1.25rem; padding-bottom: 1.25rem;"></p>

                        <!-- Area Terdampak (White Area) -->
                        <div id="detail-content-wrapper" class="p-4 flex flex-col justify-center items-center h-full" style="padding-top: 0; padding-bottom: 0.5rem;">
                            
                            <!-- Wilayah Tsunami Terekam (CSV 5 - New Highest Priority) -->
                            <div id="area-tsunami-recorded-list" class="w-full hidden pb-4">
                                <h4 class="list-header font-bold text-base text-red-600 text-center">Observasi Tinggi Tsunami</h4>
                                <table id="recorded-table" class="compact-table">
                                    <thead>
                                        <tr>
                                            <th class="w-1/4">Lokasi</th>
                                            <th class="w-1/4">Region</th>
                                            <th class="w-1/5 text-center">Tinggi (m)</th>
                                            <th class="w-1/4">Waktu Tiba (WIB)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recorded-table-body">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                                <p id="total-recorded-caption" class="mt-0.1 text-xs text-gray-500 text-center"></p>
                            </div>

                            <!-- Wilayah Terdampak BMKG List (CSV 4 - Domestik) -->
                            <div id="area-terdampak-bmkg-list" class="w-full hidden">
                                <h4 class="list-header font-bold text-base text-red-600 text-center" style="margin-top: 0; margin-bottom: 0.1rem;">Wilayah Peringatan Dini (BMKG)</h4>
                                <table id="bmkg-table" class="compact-table">
                                    <thead>
                                        <tr>
                                            <!-- Perluasan lebar Kota/Kab dan Pengecilan ETA -->
                                            <th class="w-1/4">Provinsi</th>
                                            <th class="w-2/5">Kota/Kab</th>
                                            <th class="w-1/6 text-center">Status</th>
                                            <th class="w-1/5">ETA</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bmkg-table-body">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                                <!-- CAPTION BARU: Hanya tampil jika > 10 data yang dimasukkan -->
                                <p id="total-bmkg-caption" class="mt-0.1 text-xs text-gray-500 text-center"></p>
                            </div>
                            
                            <!-- Wilayah Terdampak List (CSV 3 - Global) -->
                            <div id="area-terdampak-list" class="w-full hidden pb-4">
                                <h4 class="list-header font-bold text-base text-red-600 mb-2 text-center">Wilayah Berpotensi Terdampak (Global)</h4>
                                <ul id="terdampak-list" class="space-y-1 text-sm text-gray-700">
                                    <!-- Populated by JS -->
                                </ul>
                                <!-- Caption Total Wilayah -->
                                <p id="total-areas-caption" class="mt-2 text-xs text-gray-500 text-center"></p>
                            </div>

                            <!-- Placeholder (Center) -->
                            <div id="no-potential-area" class="text-base text-gray-500 text-center flex-grow flex items-center justify-center hidden">
                                <p id="placeholder-text">Tidak ada wilayah berpotensi tsunami</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Back Button -->
                <div class="mt-4 p-4 pt-2">
                    <button onclick="showInputPage()" class="w-full justify-center rounded-lg bg-gray-500 px-6 py-3 text-base font-semibold text-white shadow-md hover:bg-gray-600 transition duration-300 focus:outline-none">
                        Kembali ke Input
                    </button>
                </div>

                <!-- Narasi Gempa -->
                <div class="mt-8 bg-white p-4 rounded-xl border border-gray-300 shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-xl text-gray-800">Narasi Siap Publikasi</h3>
                        <button id="salin-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded-lg transition-colors shadow-lg active:scale-95">
                            Salin Narasi
                        </button>
                    </div>
                    <pre id="narasi-gempa" class="whitespace-pre-wrap text-sm text-gray-700 font-mono bg-gray-50 p-3 rounded border border-gray-200 shadow-inner"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Set Moment.js locale to Indonesian
        moment.locale('id'); 

        // Data input global
        let sourceData = null;
        let affectedAreas = []; // CSV 3: Global (Potensi)
        let affectedAreasBMKG = []; // CSV 4: BMKG (Peringatan Dini)
        let recordedAreas = []; // CSV 5: Recorded (Terekam/Observed)
        let tsunamiStatus = "";
        let map = null;
        
        // Mapping status ke warna dan emoji
        const TSUNAMI_STATUS_MAP = {
            "Berpotensi Tsunami": { color: 'red', emoji: '🔴', tailwind: 'text-white bg-red-900', map_color: '#DC2626' }, 
            // OPSI BARU
            "TSUNAMI MASIH BERLANGSUNG": { color: 'red', emoji: '⚠️', tailwind: 'text-white bg-red-900', map_color: '#DC2626' },
            // END OPSI BARU
            "Tidak Berpotensi Tsunami": { color: 'green', emoji: '🟡', tailwind: 'text-white bg-green-900', map_color: '#059669' }, 
            "Tsunami Telah Berakhir": { color: 'green', emoji: '🟢', tailwind: 'text-white bg-green-900', map_color: '#059669' } 
        };
        const BMKG_STATUS_MAP = {
            // AWAS DITAMBAHKAN
            "AWAS": { class: 'status-awas' },
            "SIAGA": { class: 'status-siaga' },
            "WASPADA": { class: 'status-waspada' },
        };
        // MAPPING WARNA KETINGGIAN TSUNAMI TEREKAM (NEW)
        function getRecordedHeightClass(height) {
            if (height >= 10.0) return 'h-10-plus'; // Ungu
            if (height >= 3.0) return 'h-3-10'; // Merah
            if (height >= 1.0) return 'h-1-3'; // Orange
            if (height >= 0.3) return 'h-03-1'; // Kuning
            if (height >= 0.05) return 'h-005-03'; // Biru Muda
            return 'bg-gray-400'; // Default jika di bawah 0.05m
        }
        
        /**
         * Mendapatkan Z-Index Offset berdasarkan ketinggian tsunami (Tinggi > Z-Index Tinggi)
         */
        function getHeightZIndexOffset(height) {
            if (height >= 10.0) return 1000; 
            if (height >= 3.0) return 900; 
            if (height >= 1.0) return 800; 
            if (height >= 0.3) return 700; 
            if (height >= 0.05) return 600; 
            return 500; 
        }
        
        // Data Legenda untuk ditampilkan
        const HEIGHT_LEGEND_DATA = [
            { range: '> 10 m', class: 'h-10-plus' },
            { range: '3 - 10 m', class: 'h-3-10' },
            { range: '1 - 3 m', class: 'h-1-3' },
            { range: '0.3 - 1 m', class: 'h-03-1' },
            { range: '0.05 - 0.3 m', class: 'h-005-03' },
        ];


        /**
         * Fungsi untuk menampilkan pesan error di UI
         */
        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        /**
         * Fungsi untuk menyembunyikan pesan error
         */
        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        /**
         * Fungsi utilitas untuk parsing data CSV sederhana
         */
        function parseCSV(csvText, expectedHeaders) {
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            
            // Header: Ambil baris pertama, trim, pisahkan, dan normalize
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            
            // Verifikasi Header
            if (headers.join(',') !== expectedHeaders.join(',')) {
                throw new Error(`Format CSV salah. Diharapkan: ${expectedHeaders.join(',')} | Ditemukan: ${headers.join(',')}`);
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                // REGEX PERBAIKAN: Lebih ketat menangani pemisahan koma, termasuk yang ada di dalam tanda kutip.
                const values = lines[i].match(/(?:[^,"]+|"[^"]*")+/g) || [];

                // Pembersihan data dan pemastian jumlah kolom
                let cleanedValues = values.map(v => v.trim().replace(/^"|"$/g, ''));
                
                if (cleanedValues.length !== headers.length) {
                    // Logic Fallback untuk jumlah kolom yang salah (misalnya, nama lokasi mengandung koma)
                    if (cleanedValues.length > headers.length) {
                         const excessCols = cleanedValues.length - headers.length;
                         // Gabungkan kelebihan kolom ke kolom Lokasi/Lokasi1
                         const combinedPrefix = cleanedValues.slice(0, 1 + excessCols).join(', ');
                         cleanedValues = [combinedPrefix, ...cleanedValues.slice(1 + excessCols)];

                    } else if (cleanedValues.length < headers.length) {
                        throw new Error(`Baris ${i + 1} memiliki jumlah kolom yang kurang. Diharapkan ${headers.length}, Ditemukan ${cleanedValues.length}`);
                    }
                }
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = cleanedValues[index];
                });

                // Konversi numerik
                if (row.lat) row.lat = parseFloat(row.lat);
                if (row.long) row.long = parseFloat(row.long);
                if (row.mag) row.mag = parseFloat(row.mag);
                if (row.kedalaman) row.kedalaman = parseFloat(row.kedalaman);
                if (row.tinggi) row.tinggi = parseFloat(row.tinggi); // TINGGI BARU

                // Validasi data penting
                const isNumericCheck = (expectedHeaders.includes('lat') && expectedHeaders.includes('long')) ? 
                                      (isNaN(row.lat) || isNaN(row.long)) : false;

                if (isNumericCheck) {
                    throw new Error(`Baris ${i + 1}: Data numerik (Lat/Long) tidak valid.`);
                }
                
                if (expectedHeaders.includes('mag') && isNaN(row.mag)) {
                    throw new Error(`Baris ${i + 1}: Data numerik (Magnitudo) tidak valid.`);
                }
                if (expectedHeaders.includes('tinggi') && isNaN(row.tinggi)) {
                    throw new Error(`Baris ${i + 1}: Data numerik (Tinggi) tidak valid.`);
                }

                data.push(row);
            }
            return data;
        }

        /**
         * Mendapatkan radius lingkaran perkiraan jangkauan berdasarkan Magnitudo.
         */
        function getRadiusByMagnitude(mag) {
            if (mag < 6) return [10000, 30000, 60000]; 
            if (mag < 7) return [30000, 60000, 120000]; 
            if (mag < 8) return [50000, 100000, 200000]; 
            return [100000, 200000, 400000]; 
        }
        
        /**
         * Format waktu menggunakan Moment.js ke zona waktu WIB.
         */
        function formatWaktu(isoString, formatType = 'tampilan') {
            if (!isoString) return 'Waktu Tidak Valid';
            const wibMoment = moment.utc(isoString).utcOffset('+07:00');

            if (!wibMoment.isValid()) {
                return 'Waktu Tidak Valid';
            }

            if (formatType === 'koordinat') {
                const formattedDate = wibMoment.format('DD MMMM YYYY');
                const formattedTime = wibMoment.format('HH:mm:ss');
                
                /* PENYESUAIAN: Membuat tampilan Tanggal dan Waktu menjadi 2 baris */
                return `
                    <div class="flex items-center space-x-1 justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        <p class="font-semibold text-white leading-tight">${formattedDate}</p>
                    </div>
                    <div class="text-center font-semibold mt-0.5 leading-tight">
                        ${formattedTime} WIB
                    </div>
                `;
            } else if (formatType === 'eta') {
                // FORMAT ETA: DD/MM HH:mm
                return wibMoment.format('DD/MM HH:mm');
            } else if (formatType === 'header') {
                // FORMAT HEADER: 09 JANUARI 2024 03:48 WIB (sampai menit)
                return wibMoment.format('DD MMMM YYYY HH:mm') + ' WIB';
            } else { // 'narasi' format lengkap
                return wibMoment.format('DD MMMM YYYY HH:mm:ss') + ' WIB';
            }
        }

        /**
         * Membuat narasi siap publikasi.
         */
        function generateNarasi(data) {
            const publishedTime = moment().utcOffset('+07:00').format('DD/MM/YYYY HH:mm') + ' WIB';
            
            const waktuHeader = formatWaktu(data.waktu, 'header');
            
            let headerType;
            let resultPhrase;
            let isDetailRequired = false;

            // LOGIKA BARU UNTUK TSUNAMI TEREKAM
            const hasRecordedAreas = recordedAreas.length > 0;

            if (data.tsunamiStatus === "Tsunami Telah Berakhir") {
                headerType = "INFORMASI TSUNAMI"; // Tanpa kata POTENSI
                resultPhrase = "GEMPA TIDAK BERPOTENSI TSUNAMI";
                
                // Jika Tsunami Terekam (CSV 5) ada, maka dianggap sebagai resume
                if (hasRecordedAreas) {
                    resultPhrase = "TSUNAMI TELAH BERAKHIR"; // Hapus **
                    isDetailRequired = true; // Aktifkan detail untuk menampilkan resume
                }
                
            } else if (data.tsunamiStatus === "Berpotensi Tsunami") {
                headerType = "INFORMASI POTENSI TSUNAMI";
                resultPhrase = "GEMPA BERPOTENSI TSUNAMI"; // Hapus **
                isDetailRequired = true;
            
            } else if (data.tsunamiStatus === "TSUNAMI MASIH BERLANGSUNG") { // OPSI BARU
                headerType = "INFORMASI TSUNAMI";
                resultPhrase = "TSUNAMI MASIH BERLANGSUNG"; // Hapus **
                isDetailRequired = true;

            } else { // Tidak Berpotensi Tsunami
                headerType = "INFORMASI POTENSI TSUNAMI";
                resultPhrase = "GEMPA TIDAK BERPOTENSI TSUNAMI";
            }

            // --- HEADER ---
            let narasi = `${headerType} AKIBAT GEMPA M${data.mag.toFixed(1)} ${data.lokasi} ${waktuHeader}\n\n`;

            // --- ISI ---
            narasi += `HASIL PEMODELAN TERBARU MENUNJUKKAN BAHWA ${resultPhrase}`;
            
            // Tambahkan frasa rincian hanya jika diperlukan (selain Tidak Berpotensi Tsunami)
            if (isDetailRequired && data.tsunamiStatus !== "Tidak Berpotensi Tsunami") {
                narasi += " DENGAN RINCIAN SEBAGAI BERIKUT :\n";
                
                // --- RINCIAN WILAYAH (PRIORITAS) ---
                const hasGlobalAreas = affectedAreas.length > 0;
                const hasBMKGAreas = affectedAreasBMKG.length > 0;

                if (hasRecordedAreas && (data.tsunamiStatus === "Tsunami Telah Berakhir" || data.tsunamiStatus === "TSUNAMI MASIH BERLANGSUNG")) {
                    // Prioritas 1: Tsunami Terekam (JIKA STATUS = BERLANGSUNG / TELAH BERAKHIR)
                    recordedAreas.sort((a, b) => moment.utc(a.waktu).diff(moment.utc(b.waktu)));

                    narasi += "\n-- TSUNAMI TEREKAM (OBSERVASI) --\n";
                    recordedAreas.forEach(area => {
                        const waktuWIB = formatWaktu(area.waktu, 'eta');
                        narasi += `• ${area.lokasi1} - ${area.lokasi2}: ${area.tinggi.toFixed(2)} meter (Waktu: ${waktuWIB})\n`;
                    });

                } else if (hasBMKGAreas) {
                    // Prioritas 2: BMKG (TAMPILKAN SEMUA DI NARASI)
                    affectedAreasBMKG.sort((a, b) => moment.utc(a.eta).diff(moment.utc(b.eta)));

                    narasi += "\n-- PERINGATAN DINI TSUNAMI (BMKG) --\n";
                    affectedAreasBMKG.forEach(area => {
                        const etaWIB = formatWaktu(area.eta, 'eta');
                        narasi += `• ${area.provinsi} - ${area.kotakab}: ${area.status.toUpperCase()} (ETA: ${etaWIB})\n`;
                    });
                
                } else if (hasGlobalAreas) {
                    // Prioritas 3: Global (TAMPILKAN SEMUA DI NARASI)
                    affectedAreas.sort((a, b) => moment.utc(a.eta).diff(moment.utc(b.eta)));

                    narasi += "\n-- WILAYAH BERPOTENSI TERDAMPAK (GLOBAL) --\n";
                    affectedAreas.forEach(area => {
                        const etaWIB = formatWaktu(area.eta, 'eta');
                        narasi += `• ${area.lokasi}, ${area.negara} (ETA: ${etaWIB})\n`;
                    });

                } else {
                     // Prioritas 4: Belum ada data
                     narasi += "\n\nDaftar wilayah berpotensi terdampak akan segera disampaikan.\n";
                }
            } else {
                 // Jika Tidak Berpotensi Tsunami, tutup baris narasi
                 narasi += "\n";
            }
            
            // --- REKOMENDASI ---
            narasi += "\n[REKOMENDASI]\n-";
            
            // --- FOOTER ---
            narasi += "\n\nData oleh ???";
            narasi += "\nSumber : ???";
            narasi += `\nDipublikasikan ${publishedTime}`;

            return narasi;
        }

        /**
         * Handler untuk submit form
         */
        document.getElementById('tsunami-form').addEventListener('submit', function(e) {
            e.preventDefault();
            hideError();

            const formData = new FormData(e.target);

            const csv1Text = formData.get('csv1_input');
            const csv2Text = formData.get('csv2_input'); // Global
            const csvBMKGText = formData.get('csv_bmkg_input'); // BMKG
            const csvRecordedText = formData.get('csv_recorded_input'); // Recorded (NEW)
            const selectedStatus = formData.get('tsunami_status');

            if (!selectedStatus) {
                displayError("Mohon pilih status peringatan tsunami.");
                return;
            }
            
            tsunamiStatus = selectedStatus;

            // 1. Parse CSV 1 (Source Data)
            try {
                const expected1 = ['mag', 'kedalaman', 'waktu', 'lat', 'long', 'lokasi'];
                const data1 = parseCSV(csv1Text, expected1);
                if (data1.length !== 1) {
                    displayError("Data Gempa Sumber harus terdiri dari satu baris data saja.");
                    return;
                }
                sourceData = data1[0];
            } catch (error) {
                displayError(`Kesalahan Data Gempa Sumber: ${error.message}`);
                return;
            }

            // 2. Parse CSV 2 (Affected Areas - Global)
            try {
                const expected2 = ['lokasi', 'negara', 'lat', 'long', 'eta'];
                affectedAreas = parseCSV(csv2Text, expected2);
            } catch (error) {
                if (csv2Text.trim().toLowerCase() !== expected2.join(',')) {
                    displayError(`Kesalahan Data Wilayah Terdampak (Global): ${error.message}`);
                    return;
                }
                affectedAreas = []; 
            }
            
            // 3. Parse CSV BMKG (Affected Areas - Domestik)
            try {
                const expectedBMKG = ['provinsi', 'kotakab', 'status', 'eta'];
                affectedAreasBMKG = parseCSV(csvBMKGText, expectedBMKG);
            } catch (error) {
                 if (csvBMKGText.trim().toLowerCase() !== expectedBMKG.join(',')) {
                    displayError(`Kesalahan Data Wilayah Terdampak (BMKG): ${error.message}`);
                    return;
                }
                affectedAreasBMKG = [];
            }
            
            // 4. Parse CSV 5 (Recorded Areas - NEW)
            try {
                const expectedRecorded = ['lokasi1', 'lokasi2', 'lat', 'long', 'tinggi', 'waktu'];
                recordedAreas = parseCSV(csvRecordedText, expectedRecorded);
            } catch (error) {
                 if (csvRecordedText.trim().toLowerCase() !== expectedRecorded.join(',')) {
                    displayError(`Kesalahan Data Tsunami Terekam: ${error.message}`);
                    return;
                }
                recordedAreas = [];
            }


            // Lanjut ke visualisasi
            showVisualizationPage();
        });

        /**
         * Menginisialisasi dan menampilkan peta Leaflet
         */
        function initializeMap() {
            if (map) {
                map.remove();
                map = null;
            }

            const centerLat = sourceData.lat;
            const centerLon = sourceData.long;
            const pacificCenterLon = 170; 
            const pacificCenterLat = 0; 

            map = L.map('map', {
                center: [pacificCenterLat, pacificCenterLon], 
                zoom: 4,
                zoomControl: false,
                worldCopyJump: true 
            });

            L.tileLayer('https://tiles.gempa.de/{z}/{x}/{y}.png', {
                maxZoom: 16,
                attribution: 'gempa.de',
                noWrap: false
            }).addTo(map);

            // --- LOGO KUSTOM (Baru) ---
            const LogoControl = L.Control.extend({
                onAdd: function(map) {
                    const img = L.DomUtil.create('img');
                    img.src = 'logo.png'; 
                    img.style.width = '60px'; 
                    img.style.height = 'auto'; 
                    img.onerror = function() {
                        this.style.display = 'none'; // Sembunyikan jika gambar tidak ditemukan
                    };
                    return img;
                },
                onRemove: function(map) {
                    // Do nothing
                }
            });

            new LogoControl({ position: 'bottomleft' }).addTo(map);

            // --- LEGENDA KETINGGIAN (NEW) ---
            const HeightLegendControl = L.Control.extend({
                onAdd: function(map) {
                    const div = L.DomUtil.create('div', 'info-legend');
                    div.innerHTML = '<strong>Tinggi Tsunami</strong>';
                    HEIGHT_LEGEND_DATA.forEach(item => {
                        const iconClass = item.class;
                        
                        // KOTAK BERWARNA SAJA (tanpa SVG)
                        const colorDiv = L.DomUtil.create('div', `legend-square ${iconClass}`);
                        colorDiv.style.width = '12px'; /* Lebar kotak */
                        colorDiv.style.height = '12px'; /* Tinggi kotak */
                        colorDiv.style.float = 'left';
                        colorDiv.style.marginRight = '5px';
                        colorDiv.style.borderRadius = '3px'; /* Sudut sedikit membulat untuk estetika */
                        
                        const span = L.DomUtil.create('span');
                        span.innerHTML = `${item.range}`;
                        
                        const line = L.DomUtil.create('div');
                        line.appendChild(colorDiv);
                        line.appendChild(span);
                        div.appendChild(line);
                    });
                    return div;
                },
                onRemove: function(map) {
                    // Do nothing
                }
            });
            
            // --- MOVE BOOLEAN DECLARATIONS UP (FIX for ReferenceError) ---
            const hasRecordedAreas = recordedAreas.length > 0;
            const hasGlobalAreas = affectedAreas.length > 0;
            const hasBMKGAreas = affectedAreasBMKG.length > 0;
            // ------------------------------------------------------------
            
            // LOGIKA KONDISIONAL UNTUK MENAMPILKAN LEGENDA
            if (hasRecordedAreas && (tsunamiStatus === "Tsunami Telah Berakhir" || tsunamiStatus === "TSUNAMI MASIH BERLANGSUNG")) {
                new HeightLegendControl({ position: 'bottomleft' }).addTo(map);
            }


            // --- UI Report Details ---
            const statusInfo = TSUNAMI_STATUS_MAP[tsunamiStatus];
            const mapColor = statusInfo.map_color; 

            // === 1. UPDATE LEFT (COLORED) BLOCK ===
            const magTimeContainer = document.getElementById('mag-time-container');
            magTimeContainer.style.backgroundColor = mapColor; 
            document.getElementById('display-time-container').innerHTML = formatWaktu(sourceData.waktu, 'koordinat');
            document.getElementById('display-magnitude').textContent = sourceData.mag.toFixed(1);
            document.getElementById('display-kedalaman').textContent = `${sourceData.kedalaman} Km`;


            // === 2. UPDATE RIGHT (WHITE) BLOCK ===
            const tsunamiDisplay = document.getElementById('display-tsunami');
            tsunamiDisplay.textContent = tsunamiStatus.toUpperCase();
            // MENGGUNAKAN PADDING VERTICAL YANG DITINGKATKAN UNTUK SENTRALISASI VERTIKAL
            tsunamiDisplay.className = `font-extrabold text-xl transition-colors border-none p-4 flex items-center justify-center ${statusInfo.tailwind}`;
            tsunamiDisplay.style.paddingTop = '1.25rem'; 
            tsunamiDisplay.style.paddingBottom = '1.25rem'; 


            // === 3. MANAGE AREA TERDAMPAK LISTS (PRIORITY LOGIC) ===
            const recordedAreaDiv = document.getElementById('area-tsunami-recorded-list'); // NEW
            const recordedTableBody = document.getElementById('recorded-table-body'); // NEW
            const totalRecordedCaption = document.getElementById('total-recorded-caption'); // NEW

            const areaTerdampakDiv = document.getElementById('area-terdampak-list');
            const terdampakListUl = document.getElementById('terdampak-list');
            const totalAreasCaption = document.getElementById('total-areas-caption');
            
            const areaTerdampakBMKGDiv = document.getElementById('area-terdampak-bmkg-list');
            const bmkgTableBody = document.getElementById('bmkg-table-body');
            const totalBmkgCaption = document.getElementById('total-bmkg-caption');

            const noPotentialArea = document.getElementById('no-potential-area');
            const placeholderText = document.getElementById('placeholder-text');

            terdampakListUl.innerHTML = '';
            bmkgTableBody.innerHTML = ''; 
            recordedTableBody.innerHTML = ''; // NEW
            

            // Sembunyikan semua list default
            recordedAreaDiv.classList.add('hidden');
            areaTerdampakDiv.classList.add('hidden');
            areaTerdampakBMKGDiv.classList.add('hidden');
            noPotentialArea.classList.add('hidden');

            const GLOBAL_DISPLAY_LIMIT_FRAME = 9; 
            const BMKG_DISPLAY_LIMIT_FRAME = 15;
            const RECORDED_DISPLAY_LIMIT_FRAME = 15; // BATAS BARU

            // LOGIKA PRIOTITAS TAMPILAN
            if (hasRecordedAreas && (tsunamiStatus === "Tsunami Telah Berakhir" || tsunamiStatus === "TSUNAMI MASIH BERLANGSUNG")) {
                // Prioritas 1: Tsunami Terekam (HANYA JIKA STATUS = BERLANGSUNG / TELAH BERAKHIR)
                recordedAreaDiv.classList.remove('hidden');
                
                // Lakukan pengurutan data Terekam berdasarkan Tinggi (tertinggi ke terendah)
                recordedAreas.sort((a, b) => b.tinggi - a.tinggi);

                const displayRecordedAreas = recordedAreas.slice(0, RECORDED_DISPLAY_LIMIT_FRAME);
                
                displayRecordedAreas.forEach(area => {
                    const waktuWIB = formatWaktu(area.waktu, 'eta');
                    const heightClass = getRecordedHeightClass(area.tinggi);
                    
                    recordedTableBody.innerHTML += `
                        <tr>
                            <td>${area.lokasi1}</td>
                            <td>${area.lokasi2}</td>
                            <td class="bmkg-center-content">
                                <span class="recorded-height-cell ${heightClass}">${area.tinggi.toFixed(2)}</span>
                            </td>
                            <td>${waktuWIB}</td>
                        </tr>
                    `;
                });
                
                // LOGIKA CAPTION RECORDED BARU
                if (recordedAreas.length > RECORDED_DISPLAY_LIMIT_FRAME) {
                     totalRecordedCaption.textContent = `+ ${recordedAreas.length - RECORDED_DISPLAY_LIMIT_FRAME} observasi lokasi lainnya.`;
                } else {
                     totalRecordedCaption.textContent = ``;
                }

            } else if (tsunamiStatus === "Berpotensi Tsunami") {
                // KONDISI BERPOTENSI TSUNAMI (Prioritas BMKG > Global)
                
                if (hasBMKGAreas) {
                    // Prioritas 2: BMKG (CSV 4)
                    areaTerdampakBMKGDiv.classList.remove('hidden');
                    affectedAreasBMKG.sort((a, b) => moment.utc(a.eta).diff(moment.utc(b.eta)));
                    const displayBMKGAreas = affectedAreasBMKG.slice(0, BMKG_DISPLAY_LIMIT_FRAME);
                    
                    displayBMKGAreas.forEach(area => {
                        const etaWIB = formatWaktu(area.eta, 'eta');
                        const statusClass = BMKG_STATUS_MAP[area.status.toUpperCase()]?.class || '';
                        
                        bmkgTableBody.innerHTML += `
                            <tr>
                                <td>${area.provinsi}</td>
                                
                                <td>${area.kotakab}</td>
                                <td class="bmkg-center-content">
                                    <span class="bmkg-status-cell ${statusClass}">${area.status.toUpperCase()}</span>
                                </td>
                                <td>${etaWIB}</td>
                            </tr>
                        `;
                    });
                    
                    if (affectedAreasBMKG.length > BMKG_DISPLAY_LIMIT_FRAME) {
                         totalBmkgCaption.textContent = `+ ${affectedAreasBMKG.length - BMKG_DISPLAY_LIMIT_FRAME} wilayah Kab/Kota lainnya.`;
                    } else {
                         totalBmkgCaption.textContent = ``;
                    }

                } else if (hasGlobalAreas) {
                    // Prioritas 3: Global (CSV 3)
                    areaTerdampakDiv.classList.remove('hidden');
                    affectedAreas.sort((a, b) => moment.utc(a.eta).diff(moment.utc(b.eta)));
                    const displayAreas = affectedAreas.slice(0, GLOBAL_DISPLAY_LIMIT_FRAME); 

                    displayAreas.forEach(area => {
                        const etaWIB = formatWaktu(area.eta, 'eta');
                        terdampakListUl.innerHTML += `
                            <li class="flex justify-between items-center pb-0.5">
                                <span class="text-xs text-gray-700">${area.lokasi}, ${area.negara}</span>
                                <span class="font-semibold text-xs text-red-600">${etaWIB}</span>
                            </li>
                        `;
                    });

                    if (affectedAreas.length > GLOBAL_DISPLAY_LIMIT_FRAME) { 
                        totalAreasCaption.textContent = `... ${affectedAreas.length - GLOBAL_DISPLAY_LIMIT_FRAME} wilayah lainnya tidak ditampilkan.`;
                    } else {
                        totalAreasCaption.textContent = `Total ${affectedAreas.length} wilayah teridentifikasi.`;
                    }
                    
                } else {
                    // Prioritas 4: Belum ada data
                    noPotentialArea.classList.remove('hidden');
                    placeholderText.textContent = "Daftar wilayah berpotensi terdampak akan segera disampaikan"; 
                }

            } else {
                // KONDISI 5: Tidak Berpotensi Tsunami ATAU Tsunami Telah Berakhir (tanpa data Recorded)
                noPotentialArea.classList.remove('hidden');
                placeholderText.textContent = "Tidak ada wilayah berpotensi tsunami"; 
            }


            // Generate and display Narasi
            document.getElementById('narasi-gempa').textContent = generateNarasi({ 
                ...sourceData, 
                tsunamiStatus: tsunamiStatus
            });


            // --- MAP MARKERS AND ZOMM ---
            // Marker peta selalu menggunakan data Global (CSV 3)

            // Tsunami Icon (NEW)
            const tsunamiIconSVG = (colorClass) => {
                // Tentukan warna stroke (hitam untuk kuning, putih untuk lainnya)
                let strokeColor = 'white';
                if (colorClass === 'h-03-1') {
                    strokeColor = 'black'; // Kuning -> Stroke Hitam
                }
                
                return `
                    <div class="recorded-wave-icon-container ${colorClass}" style="width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${strokeColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 15s1-2 2-2 2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2 1 2 2 2"/>
                            <path d="M2 9s1-2 2-2 2 2 4 2 2-2 4-2 2 2 4 2 2-2 4-2 1 2 2 2"/>
                        </svg>
                    </div>
                `;
            }
            
            // Seismic Icon
            const seismicIconSVG = (color) => `
                <div style="width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; background-color: white; box-shadow: 0 0 5px rgba(0,0,0,0.3);">
                    <svg class="seismic-icon" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 12h4l3-8 4 16 3-8h4"/>
                    </svg>
                </div>
            `;

            const sourceIcon = L.divIcon({
                className: 'custom-div-icon',
                html: seismicIconSVG(mapColor),
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const markers = []; 

            function addWrappingMarker(lat, lon, icon, zIndex = 500) {
                markers.push(L.marker([lat, lon], { icon: icon, zIndexOffset: zIndex }).addTo(map));
                markers.push(L.marker([lat, lon + 360], { icon: icon, zIndexOffset: zIndex }).addTo(map));
                markers.push(L.marker([lat, lon - 360], { icon: icon, zIndexOffset: zIndex }).addTo(map));
            }

            // Marker Episentrum (Z-Index selalu tertinggi)
            addWrappingMarker(centerLat, centerLon, sourceIcon, 2000);

            // Lingkaran Jangkauan
            const radii = getRadiusByMagnitude(sourceData.mag);
            const circleColor = mapColor; 

            radii.forEach((radius, index) => {
                const fillOpacity = (0.3 - index * 0.1);
                
                const circle = L.circle([centerLat, centerLon], { 
                    radius: radius, 
                    color: circleColor, 
                    weight: 1, 
                    fillColor: circleColor, 
                    fillOpacity: fillOpacity 
                }).addTo(map);

                L.circle([centerLat, centerLon + 360], { 
                    radius: radius, 
                    color: circleColor, 
                    weight: 1, 
                    fillColor: circleColor, 
                    fillOpacity: fillOpacity
                }).addTo(map);

                L.circle([centerLat, centerLon - 360], { 
                    radius: radius, 
                    color: circleColor, 
                    weight: 1, 
                    fillColor: circleColor, 
                    fillOpacity: fillOpacity 
                }).addTo(map);

                if (index === radii.length - 1) { 
                    markers.push(circle);
                }
            });

            // MARKER CSV 5 (TSUNAMI TEREKAM) - Dengan Z-Index berdasarkan Ketinggian
            if (hasRecordedAreas && (tsunamiStatus === "Tsunami Telah Berakhir" || tsunamiStatus === "TSUNAMI MASIH BERLANGSUNG")) {
                
                // Urutkan data berdasarkan tinggi (tertinggi ke terendah) agar dirender dari bawah ke atas
                recordedAreas.sort((a, b) => a.tinggi - b.tinggi); 

                recordedAreas.forEach(area => {
                    const heightClass = getRecordedHeightClass(area.tinggi);
                    const zIndex = getHeightZIndexOffset(area.tinggi); // Dapatkan Z-Index Offset
                    
                    const recordedIcon = L.divIcon({
                        className: 'recorded-wave-icon', 
                        html: tsunamiIconSVG(heightClass),
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    // Tambahkan Marker dengan Z-Index Offset
                    addWrappingMarker(area.lat, area.long, recordedIcon, zIndex);
                });
            }

            // MARKER CSV 3 (POTENSI GLOBAL) - Dengan Wrapping (Marker Segitiga Ungu)
            if (hasGlobalAreas && tsunamiStatus === "Berpotensi Tsunami") {
                // SVG Segitiga yang lebih sederhana dan robust
                const warningIconSVG = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="#6B21A8" stroke="white" stroke-width="1.5"/>
                        <line x1="12" y1="8" x2="12" y2="14" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                        <circle cx="12" cy="17" r="1" fill="white"/>
                    </svg>
                `;
                
                const warningIcon = L.divIcon({
                    // MENGHAPUS BACKGROUND YANG MENGGANGGU RENDERING
                    className: 'global-warning-marker', 
                    html: warningIconSVG,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });
                
                // Marker Potensi Global (Z-Index standar 1000)
                affectedAreas.forEach(area => {
                    addWrappingMarker(area.lat, area.long, warningIcon, 1000); 
                });
            }

            // Auto-Zoom: Hanya zoom ke markers jika ada recorded area atau global area
            const allMarkers = markers.concat(
                hasRecordedAreas ? recordedAreas.map(a => L.marker([a.lat, a.long])) : [],
                (hasGlobalAreas && tsunamiStatus === "Berpotensi Tsunami") ? affectedAreas.map(a => L.marker([a.lat, a.long])) : []
            );

            const group = new L.featureGroup(allMarkers); 
            const bounds = group.getBounds();
            
            if (bounds.isValid() && allMarkers.length > 0) {
                 map.fitBounds(bounds.pad(0.1));
            } else {
                map.setView([pacificCenterLat, pacificCenterLon], 4);
            }
        }

        /**
         * Fungsi untuk beralih ke halaman input
         */
        function showInputPage() {
            document.getElementById('input-page').classList.remove('hidden');
            document.getElementById('visualization-page').classList.add('hidden');
            if (map) {
                map.remove();
                map = null;
            }
        }

        /**
         * Fungsi untuk beralih ke halaman visualisasi
         */
        function showVisualizationPage() {
            document.getElementById('input-page').classList.add('hidden');
            document.getElementById('visualization-page').classList.remove('hidden');
            
            setTimeout(initializeMap, 100);
        }

        // --- Setup Copy Button Logic ---
        function setupCopyButton() {
            const salinBtn = document.getElementById('salin-btn');
            const narasiDisplay = document.getElementById('narasi-gempa');

            salinBtn.addEventListener('click', () => {
                const narasiText = narasiDisplay.textContent;
                const textArea = document.createElement('textarea');
                textArea.value = narasiText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = salinBtn.textContent;
                    salinBtn.textContent = 'Tersalin!';
                    salinBtn.classList.add('bg-green-500');
                    setTimeout(() => {
                        salinBtn.textContent = originalText;
                        salinBtn.classList.remove('bg-green-500');
                    }, 2000);
                } catch (err) {
                    console.error('Gagal menyalin:', err);
                }
                document.body.removeChild(textArea);
            });
        }
        
        // Jalankan setup dan contoh data saat dokumen dimuat
        document.addEventListener('DOMContentLoaded', () => {
            setupCopyButton();
            
            // MENGEMBALIKAN PLACEHOLDER DATA LENGKAP
            document.getElementById('csv1-input').value = ``;
            document.getElementById('csv1-input').placeholder = `mag,kedalaman,waktu,lat,long,lokasi
7.1,10.0,2025-09-25T16:44:55Z,45.21,148.55,"Kepulauan Kuril Selatan"`;
            
            document.getElementById('csv2-input').value = ``;
            document.getElementById('csv2-input').placeholder = `lokasi,negara,lat,long,eta
Kuril Islands,Russia,45.3,149.0,2025-09-25T17:15:00Z
Hokkaido,Jepang,42.5,145.0,2025-09-25T17:45:00Z
Maui,USA,20.79, -156.33, 2025-09-25T20:00:00Z
Mexico City,Mexico,19.43,-99.13,2025-09-25T22:30:00Z
Lima,Peru,-12.04,-77.04,2025-09-26T01:00:00Z
Sydney,Australia,-33.86,151.20,2025-09-26T03:00:00Z
Auckland,NZ,-36.84,174.76,2025-09-26T04:00:00Z
Manila,Philippines,14.59,120.98,2025-09-26T05:30:00Z
Vancouver,Canada,49.28,-123.12,2025-09-26T07:00:00Z`; 
            
            document.getElementById('csv-bmkg-input').value = ``;
            document.getElementById('csv-bmkg-input').placeholder = `provinsi,kotakab,status,eta
SULAWESI UTARA,KEPULAUAN SANGIHE,AWAS,2025-09-25T16:55:00Z
PAPUA,JAYAPURA,Siaga,2025-09-25T17:15:00Z
SULUT,KEPULAUAN TALAUD,Waspada,2025-09-25T17:45:00Z
MALUT,HALMAHERA UTARA,Waspada,2025-09-26T01:00:00Z
NTT,KABUPATEN ALOR,Waspada,2025-09-26T01:30:00Z
MALUKU,KOTA AMBON,Siaga,2025-09-26T02:00:00Z
BANTEN,PANDEGLANG,Waspada,2025-09-26T02:30:00Z
SUMUT,NIAS SELATAN,Siaga,2025-09-26T03:00:00Z
ACEH,PULAU SIMEULUE,Waspada,2025-09-26T03:30:00Z
PAPUABAR,MANOKWARI,Waspada,2025-09-26T04:00:00Z
SULSEL,KABUPATEN SELAYAR,Siaga,2025-09-26T04:30:00Z
MALUKU UTARA,KABUPATEN PULAU MOROTAI,AWAS,2025-09-26T05:00:00Z`;
            
            document.getElementById('csv-recorded-input').value = ``;
            document.getElementById('csv-recorded-input').placeholder = `lokasi1,lokasi2,lat,long,tinggi,waktu
Fukushima,Jepang,37.5,141.0,0.25,2025-09-25T18:00:00Z
Kilauea,Hawaii,19.5,-155.0,0.85,2025-09-25T21:30:00Z
Hilo,Hawaii,19.7,-155.1,1.5,2025-09-26T01:00:00Z
Valparaiso,Chile,-33.0,-71.6,4.5,2025-09-26T04:30:00Z
Lombok,Indonesia,-8.5,116.0,12.5,2025-09-26T06:00:00Z`;
            
            document.querySelector('input[value="Berpotensi Tsunami"]').checked = true;

            showInputPage();
        });

    </script>
</body>
</html>






